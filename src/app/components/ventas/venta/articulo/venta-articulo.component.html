<div class="venta-articulo">

    <div class="separator"></div>

    <div class="container">
        <form [formGroup]="form"  (ngSubmit)="onAdd()">
            <div class="form-row" style="grid-template-columns: 1fr 150px;">
                <div class="form-row one-col">
                    <div class="form-row" style="grid-template-columns: 230px 1fr;">
                        <mat-radio-group (change)="onRadioChange($event)" [value]="'almacen'" style="padding: 25px 0px;" formControlName="tipoAlmacen"> 
                            <mat-radio-button value="almacen">Almacen</mat-radio-button>
                            <mat-radio-button value="sucursal">Sucursal</mat-radio-button>
                        </mat-radio-group>
                        <div style="padding: 0px 32px 0px 0px;">
                            <mat-label class="text-1">{{ isAlmacen ? 'Almacén' : 'Sucursal'}}</mat-label><br/>
                            <mat-form-field *ngIf="isAlmacen" style="width: 100%;">
                                <mat-select [(value)]="selectedAlmacen" (selectionChange)="onAlmacenChange($event)" formControlName="almacen">
                                    <mat-option *ngFor="let almacen of almacenes" [value]="almacen">{{ almacen.name }}</mat-option>
                                </mat-select>
                            </mat-form-field>
                            <mat-form-field  *ngIf="!isAlmacen" style="width: 100%;">
                                <mat-select [(value)]="selectedSucursal" (selectionChange)="onAlmacenChange($event)" formControlName="sucursal">
                                    <mat-option *ngFor="let sucursal of sucursales" [value]="sucursal">{{ sucursal.name }}</mat-option>
                                </mat-select>
                            </mat-form-field>
                        </div>
                    </div>
                    <div class="autocomplete-articulo-container">
                        <mat-form-field>
                            <input type="text"
                                   matInput
                                   required
                                   [matAutocomplete]="autoGroup"
                                   formControlName="selectedArticle">
                                   <button type="button" *ngIf="isEditing == false" matSuffix mat-icon-button aria-label="Clear" (click)="clearAutocompleteInput()">
                                      <mat-icon>close</mat-icon>
                                  </button>
                            <mat-autocomplete autoActiveFirstOption #autoGroup="matAutocomplete">
                              <ng-container *ngFor="let group of articuloGroupOptions | async; trackBy: trackGroupFn">
                                  <mat-optgroup [label]="group.categoria!.name ?? ''">
                                      <ng-container *ngFor="let articulo of group.articulos; trackBy: trackArticuloFn">
                                          <mat-option [value]="articulo.part_number">
                                              <img class="option-img" [ngClass]="{ 'no-image': articulo.photo == '' }" [src]="getUrlPhoto(articulo)">
                                              <span>{{articulo.part_number}}</span>
                                          </mat-option>
                                      </ng-container>
                                </mat-optgroup>
                              </ng-container>
                            </mat-autocomplete>
                        </mat-form-field>
                        <button *ngIf="isEditing == false" type="button" mat-icon-button matTooltip="escanear codigo de barras"  (click)="openDialogEscanner()">
                            <mat-icon>photo_camera</mat-icon>
                        </button>
                    </div>
                </div>
                <div class="column-photo">
                    <div *ngIf="!imageUrl" class="empty-image-container">
                        <img src="../../assets/images/empty-image.png" class="empty-image">
                    </div>
                    <img class="photo" *ngIf="imageUrl" [src]="imageUrl">
                </div>
            </div>
            <div class="form-row" style="grid-template-columns: 1fr 1fr 200px 150px; gap: 20px;">
                <div class="form-field" style="margin-top: 0px; width: 190px;">
                    <mat-label class="text-1"  *ngIf="isReadOnly">Precio venta</mat-label>
                    <mat-label class="text-1-regular" *ngIf="isReadOnly">{{this.f['precio_venta'].value}}</mat-label>

                    <mat-label class="text-1"  *ngIf="!isReadOnly">Precio venta*</mat-label>
                    <mat-form-field floatLabel="always" *ngIf="!isReadOnly">
                        <input matInput type="number" class="example-right-align" placeholder="0" formControlName="precio_venta" min="0" step="0.01" (keypress)="validarDecimal($event)" (change)="calcularSubTotal()">
                        <span matTextPrefix>$&nbsp;</span>
                    </mat-form-field>
                </div>
                <div class="form-field" style="margin-top: 0px; width: 190px;">
                    <mat-label class="text-1"  *ngIf="isReadOnly">Descuento (opcional)</mat-label>
                    <mat-label class="text-1-regular" *ngIf="isReadOnly">{{this.f['descuento'].value}}</mat-label>

                    <mat-label class="text-1"  *ngIf="!isReadOnly">Descuento (opcional)</mat-label>
                    <mat-form-field floatLabel="always" *ngIf="!isReadOnly">
                        <input matInput type="number" class="example-right-align" placeholder="0" formControlName="descuento" min="0" step="0.01" (keypress)="validarDecimal($event)" (change)="calcularSubTotal()">
                        <span matTextPrefix>$&nbsp;</span>
                    </mat-form-field>
                </div>
                <div style="grid-template-columns: 1fr">
                    <mat-label class="text-1" style="margin-left: 44px;">Cantidad</mat-label>
                    <div class="container-agregar-retirar">
                        <button type="button" color="primary" mat-mini-fab (click)="restarQty()">
                            <mat-icon>remove</mat-icon>
                        </button>
                        <mat-form-field>
                            <input type="number" matInput formControlName="qty" [ngClass]="{ 'is-invalid': submitted && f['qty'].errors }" required (change)="calcularSubTotal()">
                        </mat-form-field>
                        <button type="button" color="primary" mat-mini-fab (click)="agregarQty()">
                            <mat-icon>add</mat-icon>
                        </button>
                    </div>
                </div>
                <div [matBadge]="(f['qty'].value > 0 ? '-' : '') + f['qty'].value" matBadgeOverlap="false"
                    class="stock_indicator" [ngClass]="{
                    'stock_indicator-neg': f['qty'].value > 0,
                    'stock_indicator-hide': f['qty'].value === 0 || f['qty'].value === null
                  }">
                    <span class="title-stock">Stock</span>
                    <span class="stock">{{stock}}</span>
                </div>
            </div>
            <div class="form-row" style="grid-template-columns: 70px 1fr; column-gap: 12px;">
                <span class="resumen-label">Subtotal</span>
                <div class="resumen-value">{{formatearComoMoneda(subtotal)}}</div>
            </div>

            <div class="separator-title" style="margin-top: 24px;">
                <span>Datos Fiscales CFDI</span>
                <div class="separator" style="margin-top: 10px; background-color: #C2CFE0;"></div>
            </div>
            <div class="form-row two-col" style="column-gap: 24px;">
                <div class="form-field">
                    <mat-label class="text-1"  *ngIf="isReadOnly">No. Identificación </mat-label>
                    <mat-label class="text-1-regular" *ngIf="isReadOnly">{{this.f['numero_identificacion_fiscal'].value}}</mat-label>
    
                    <mat-label class="text-1"  *ngIf="!isReadOnly">No. Identificación </mat-label>
                    <mat-form-field *ngIf="!isReadOnly">
                        <input matInput formControlName="numero_identificacion_fiscal">
                    </mat-form-field>
                </div>
                <div class="form-field">
                    <mat-label class="text-1" *ngIf="isReadOnly">Unidad de medida</mat-label>
                    <mat-label class="text-1-regular" *ngIf="isReadOnly">{{this.f['unidad_medida'].value}}</mat-label>
                    <mat-label class="text-1" *ngIf="!isReadOnly">Unidad de medida*</mat-label>
                    <mat-form-field>
                        <mat-label>Seleccionar</mat-label>
                        <mat-select formControlName="unidad_medida" value="producto">
                          <mat-option value="producto">Producto</mat-option>
                          <mat-option value="servicio">Servicio</mat-option>
                        </mat-select>
                    </mat-form-field>
                </div>
            </div>
            <div class="form-row one-col">
                <!--<div class="form-field">
                    <mat-label class="text-1" *ngIf="isReadOnly">ProdServ (Producto/ Servicio)</mat-label>
                    <mat-label class="text-1-regular" *ngIf="isReadOnly">{{this.f['producto_servicio'].value}}</mat-label>
                    <mat-label class="text-1" *ngIf="!isReadOnly">ProdServ (Producto/ Servicio) *</mat-label>
                    <mat-form-field>
                        <mat-label>Seleccionar</mat-label>
                        <mat-select [(value)]="selectedProductoServicio" formControlName="producto_servicio" >
                            <mat-option *ngFor="let productoServicio of productoServicioList" [value]="productoServicio">{{ productoServicio.key }} - {{ productoServicio.name }}</mat-option>
                        </mat-select>
                    </mat-form-field>
                    <div *ngIf="submitted && f['producto_servicio'].errors" class="invalid-feedback">
                        <div *ngIf="f['producto_servicio'].errors['required']">Este campo requerido</div>
                    </div>
                </div>
                <div class="form-field">
                    <mat-label class="text-1" *ngIf="isReadOnly">Unidad de medida</mat-label>
                    <mat-label class="text-1-regular" *ngIf="isReadOnly">{{this.f['unidadMedida'].value}}</mat-label>
                    <mat-label class="text-1" *ngIf="!isReadOnly">Unidad de medida *</mat-label>
                    <mat-form-field>
                        <mat-label>Seleccionar</mat-label>
                        <mat-select [(value)]="selectedProductoServicio" formControlName="unidadMedida" >
                            <mat-option *ngFor="let productoServicio of productoServicioList" [value]="productoServicio">{{ productoServicio.key }} - {{ productoServicio.name }}</mat-option>
                        </mat-select>
                    </mat-form-field>
                    <div *ngIf="submitted && f['unidadMedida'].errors" class="invalid-feedback">
                        <div *ngIf="f['unidadMedida'].errors['required']">Este campo requerido</div>
                    </div>
                </div>-->
                <div class="form-field">
                    <mat-form-field>
                        <mat-label>Comentarios</mat-label>
                        <textarea matInput formControlName="comentarios" rows="2"></textarea>
                    </mat-form-field>    
                </div>
            </div>

            <div style="position: absolute; bottom: 40px;" *ngIf="submitted && f['precio_venta'].errors" class="invalid-feedback">
                <div *ngIf="f['precio_venta'].errors['min']">Precio de venta debe ser mayor a 0</div>
            </div>
            <div style="position: absolute; bottom: 20px;" *ngIf="submitted && f['selectedArticle'].errors" class="invalid-feedback">
                <div *ngIf="f['selectedArticle'].errors['required']">Debe seleccionar un articulo</div>
            </div>
            <div class="toolbar-bottom">
                <button mat-flat-button class="btn secundary" type="button" (click)="onCancel()">Cancelar</button>
                <button mat-flat-button class="btn" type="submit">{{action}}</button>
            </div>
        </form>
    </div>
</div>